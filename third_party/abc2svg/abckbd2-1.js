var abc_kb=false,kbds,oct=4,dur=4,chord;var dur_tb=["////","///","//","/","","2","4","8","16"],key={"`":"`",a:"|",s:"=",d:"d-",f:"d+",z:"_",x:"^",c:"o-",v:"o+",j:"C",k:"D",l:"E",";":"F",m:"G",",":"A",".":"B","/":"z",g:"[]",h:".","\n":"\n"};function stop_key(e){e.stopImmediatePropagation();e.preventDefault();src_change()}function kbd_upd(){var c=chord?"[":"";switch(oct){case 2:c+="C,,";break;case 3:c+="C,";break;default:c+="C";break;case 5:c+="c";break;case 6:c+="c'";break;case 7:c+="c''";break}kbds.innerHTML="kbd "+c+dur_tb[dur]}function key_press(e){if(e.ctrlKey)return;var st,en,kc=e.which,c=String.fromCharCode(kc),s=document.getElementById("source");function get_note(){var ch;if(!s.value)return;en=st=s.selectionEnd;while(1){if(st==0)break;if(!s.value[--st].match(/[1-9,'/\]]/))break;if(s.value[st]=="]")ch=true}if(!s.value[st].match(/[A-Ga-gz]/))return;if(ch){while(1){if(st==0)return;if(s.value[--st]=="[")break}}return s.value.slice(st,en)}c=key[c];switch(c){case undefined:if(kc==8)break;return;case"`":abc_kb=!abc_kb;kbds.style.backgroundColor=abc_kb?"#80ff80":"#ffd0d0";stop_key(e);return}if(!abc_kb)return;if(kc==8){c=get_note();if(!c)return;s.value=s.value.slice(0,st)+s.value.slice(en);s.setSelectionRange(st,st);stop_key(e);return}switch(c[0]){case"A":case"B":case"C":case"D":case"E":case"F":case"G":switch(oct){case 2:c=c+",,";break;case 3:c=c+",";break;case 5:c=c.toLowerCase();break;case 6:c=c.toLowerCase()+"'";break;case 7:c=c.toLowerCase()+"''";break}if(!chord)c+=dur_tb[dur];break;case"z":c+=dur_tb[dur];break;case"d":if(c[1]=="+"){if(dur<dur_tb.length-1)dur++}else{if(dur>0)dur--}kbd_upd();c=null;break;case"o":if(c[1]=="+"){if(oct<7)oct++}else{if(oct>2)oct--}kbd_upd();c=null;break;case"[":chord=!chord;kbd_upd();c=chord?"[":"]"+dur_tb[dur];break;case".":c=get_note();if(!c)break;if(!c.match(/2|3|4|6|\/\/|\//))c+="3/";else c=c.replace(/2|3|4|6|\/\/|\//,function(a){switch(a){case"2":return"3";case"3":return"7/";case"4":return"6";case"6":return"7";case"//":return"3///";case"/":return"3//";default:return"3/"}});s.value=s.value.slice(0,st)+c+s.value.slice(en);st+=c.length;s.setSelectionRange(st,st);c=null;break}if(c){st=s.selectionStart;s.value=s.value.slice(0,st)+c+s.value.slice(st);st+=c.length;s.setSelectionRange(st,st)}stop_key(e)}function kbd_init(){document.getElementById("source").addEventListener("keypress",key_press);var tmp=document.createElement("div");tmp.id="abckbd";tmp.className="popup";tmp.style.width="600px";tmp.innerHTML='<div class="close" onclick="popshow(\'abckbd\')">x</div><table> <tr>\t<td>kbd-<br/>-chg</td>  <td></td> <td></td> <td></td> <td></td> <td></td> <td></td>\t<td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr>\t<td style="border:0"></td>  <td> </td> <td></td> <td></td> <td></td> <td></td> <td></td>\t<td></td> <td></td> <td></td> <td></td> <td>  </td> <td>  </td> </tr> <tr>\t<td style="border:0"></td>  <td>|</td> <td>=</td> <td>d-</td> <td>d+</td> <td>[]</td> <td>dot</td>\t<td>C</td> <td>D</td> <td>E</td> <td>F</td> <td></td> <td></td> </tr> <tr>\t<td style="border:0"></td>  <td>_</td> <td>^</td> <td>o-</td> <td>o+</td> <td></td> <td></td>\t<td>G</td> <td>A</td> <td>B</td> <td>z</td> </tr> <tr>\t<td style="border:0" colspan="3"></td>  <td colspan="6">space</td> </tr></table>';document.body.appendChild(tmp);kbds=document.createElement("li");kbds.addEventListener("click",function(){popshow("abckbd",true)});kbds.className="dropbutton";kbds.style.backgroundColor="#ffd0d0";kbds.innerHTML="kbd c2";document.getElementById("er").parentNode.appendChild(kbds);tmp=document.createElement("div");tmp.id="kbdhelp";tmp.className="popup";tmp.style.width="600px";tmp.innerHTML="<div class=\"close\" onclick=\"popshow('kbdhelp')\">x</div><ul id=\"khlp\"><li>The ABC keyboard is enabled/disabled by pressing the key '<code>`</code>'.<br/>The layout of the keyboard is displayed by clicking on the keyboard state<br/>(below <code>File</code>).</li><li>When the keyboard is enabled: <ul> <li>the right hand enters the notes and rests,</li> <li>the left hand enters the measure bars and the accidentals,<br/>\tand also controls the duration '<code>d-/d+</code>'\tand the octave '<code>o-/o+</code>',</li> <li>'<code>dot</code>' adds a music <i>dot</i>,</li> <li>'<code>[]</code>' starts/stops chords,</li> <li>'<code>space</code>' inserts a beam break.</li> </ul></li></ul>";document.body.appendChild(tmp);tmp=document.createElement("li");tmp.addEventListener("click",function(){popshow("kbdhelp",true)});tmp.innerHTML="Keyboard help";var help=document.getElementById("ha").parentNode;help.insertBefore(tmp,help.childNodes[2]);kbd_upd()}kbd_init();
