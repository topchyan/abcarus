name: Release Assets

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (e.g. v0.16.2)"
        required: true
        default: "v0.16.2"

permissions:
  contents: write

jobs:
  linux-appimage:
    name: Linux AppImage (x86_64)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install appimagetool
        run: |
          mkdir -p ../appimagetool
          curl -L --fail -o ../appimagetool/appimagetool-x86_64.AppImage \
            https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x ../appimagetool/appimagetool-x86_64.AppImage

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Build AppImage
        run: bash scripts/build_appimage_release.sh

      - name: Compute SHA256
        run: |
          cd dist/appimage
          sha256sum ABCarus-x86_64.AppImage > SHA256SUMS-linux.txt

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/appimage/ABCarus-x86_64.AppImage
            dist/appimage/SHA256SUMS-linux.txt

  windows-x64:
    name: Windows (x64)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Install bundled Python (PBS)
        run: pwsh -ExecutionPolicy Bypass -File devtools/pbs/pbs-install-windows.ps1 -Platform win-x64

      - name: Build Windows artifact
        run: npx electron-builder --win --x64 --publish never

      - name: Create portable zip
        run: |
          $src = "dist/electron-builder/win-unpacked"
          $zip = "dist/electron-builder/ABCarus-win-unpacked-x64.zip"
          if (!(Test-Path $src)) { throw "Missing win-unpacked: $src" }
          if (!(Test-Path (Join-Path $src "ffmpeg.dll"))) {
            Write-Host "Top-level in win-unpacked:"
            Get-ChildItem -Force -Path $src | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "ffmpeg.dll is missing in win-unpacked"
          }
          $readme = @(
            "ABCarus portable build (Windows)",
            "",
            "IMPORTANT:",
            "  - Extract the entire zip to a folder before running.",
            "  - Do NOT run ABCarus.exe directly from inside the zip viewer,",
            "    otherwise required DLLs (e.g. ffmpeg.dll) may not be found."
          ) -join "`r`n"
          $readme | Out-File -Encoding ascii (Join-Path $src "README-PORTABLE.txt")
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path "$src/*" -DestinationPath $zip

      - name: Create portable SFX (optional)
        run: |
          $src = "dist/electron-builder/win-unpacked"
          $out = "dist/electron-builder/ABCarus-win-unpacked-x64.exe"
          if (!(Test-Path $src)) { throw "Missing win-unpacked: $src" }

          $sevenZip = @(
            "C:\\Program Files\\7-Zip\\7z.exe",
            "C:\\Program Files (x86)\\7-Zip\\7z.exe"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          $sevenZipSfx = @(
            "C:\\Program Files\\7-Zip\\7z.sfx",
            "C:\\Program Files (x86)\\7-Zip\\7z.sfx"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (!$sevenZip -or !$sevenZipSfx) {
            Write-Host "Skipping SFX build (7-Zip SFX not found on runner)."
            exit 0
          }

          $tmp = Join-Path $env:TEMP ("abcarus-sfx-" + [System.Guid]::NewGuid().ToString("N"))
          New-Item -ItemType Directory -Force -Path $tmp | Out-Null

          $payload = Join-Path $tmp "payload.7z"
          & $sevenZip a -t7z -mx=9 $payload "$src\\*" | Out-Host

          $config = Join-Path $tmp "config.txt"
          $configText = @(
            ';!@Install@!UTF-8!',
            'Title="ABCarus (portable)"',
            'BeginPrompt="Extract ABCarus portable build to a folder. Do NOT run from inside a zip viewer."',
            'RunProgram="ABCarus.exe"',
            ';!@InstallEnd@!'
          ) -join "`r`n"
          $configText | Out-File -Encoding utf8 $config

          $bytes = New-Object System.Collections.Generic.List[byte]
          $bytes.AddRange([System.IO.File]::ReadAllBytes($sevenZipSfx))
          $bytes.AddRange([System.Text.Encoding]::UTF8.GetBytes((Get-Content -Raw $config)))
          $bytes.AddRange([System.IO.File]::ReadAllBytes($payload))
          [System.IO.File]::WriteAllBytes($out, $bytes.ToArray())

          Write-Host "Created SFX: $out"

      - name: Compute SHA256
        run: |
          $setup = Get-ChildItem -Path "dist/electron-builder" -Filter "*Setup*.exe" | Select-Object -First 1
          if (-not $setup) { throw "Setup exe not found under dist/electron-builder" }
          $zip = "dist/electron-builder/ABCarus-win-unpacked-x64.zip"
          $sfx = "dist/electron-builder/ABCarus-win-unpacked-x64.exe"
          $lines = @()
          $lines += "$( (Get-FileHash -Algorithm SHA256 $setup.FullName).Hash.ToLower() )  $($setup.Name)"
          $lines += "$( (Get-FileHash -Algorithm SHA256 $zip).Hash.ToLower() )  $(Split-Path -Leaf $zip)"
          if (Test-Path $sfx) {
            $lines += "$( (Get-FileHash -Algorithm SHA256 $sfx).Hash.ToLower() )  $(Split-Path -Leaf $sfx)"
          }
          $lines | Out-File -Encoding ascii "dist/electron-builder/SHA256SUMS-windows.txt"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/electron-builder/*Setup*.exe
            dist/electron-builder/ABCarus-win-unpacked-x64.zip
            dist/electron-builder/ABCarus-win-unpacked-x64.exe
            dist/electron-builder/SHA256SUMS-windows.txt
