name: Release Assets

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (e.g. v0.16.2)"
        required: true
        default: "v0.16.2"

permissions:
  contents: write

jobs:
  linux-appimage:
    name: Linux AppImage (x86_64)
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install appimagetool
        run: |
          mkdir -p ../appimagetool
          curl -L --fail -o ../appimagetool/appimagetool-x86_64.AppImage \
            https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x ../appimagetool/appimagetool-x86_64.AppImage

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Build AppImage
        run: bash scripts/build_appimage_release.sh

      - name: Create portable tar.gz (AppDir)
        run: |
          cat > dist/appimage/AppDir/README-PORTABLE.txt <<'EOF'
          ABCarus portable folder build (Linux)
          
          This tarball contains the AppImage "AppDir" folder, packaged as a portable directory.
          
          Usage:
            1) Extract the entire tar.gz into a folder.
            2) Run:
                 ./AppRun
               (or: ./usr/bin/abcarus)
          
          Notes:
            - Keep the folder structure intact.
            - If you prefer a single-file app, use the AppImage build instead.
          EOF
          chmod 0644 dist/appimage/AppDir/README-PORTABLE.txt
          tar -C dist/appimage/AppDir -czf dist/appimage/ABCarus-x86_64-portable.tar.gz .

      - name: Compute SHA256
        run: |
          cd dist/appimage
          sha256sum ABCarus-x86_64.AppImage ABCarus-x86_64-portable.tar.gz > SHA256SUMS-linux.txt

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/appimage/ABCarus-x86_64.AppImage
            dist/appimage/ABCarus-x86_64-portable.tar.gz
            dist/appimage/SHA256SUMS-linux.txt

  macos-arm64:
    name: macOS (arm64)
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Install bundled Python (PBS)
        run: bash devtools/pbs/pbs-install-unix.sh darwin-arm64

      - name: Build macOS artifact
        run: npx electron-builder --mac --arm64 --publish never

      - name: Capture stable-name dmg
        run: |
          dmg="$(ls -1 dist/electron-builder/*.dmg 2>/dev/null | head -n 1 || true)"
          if [[ -z "${dmg}" ]]; then
            echo "No .dmg found under dist/electron-builder"
            ls -la dist/electron-builder || true
            exit 1
          fi
          cp -f "${dmg}" dist/electron-builder/ABCarus-macos-arm64.dmg

      - name: Compute SHA256
        run: |
          cd dist/electron-builder
          shasum -a 256 ABCarus-macos-arm64.dmg > SHA256SUMS-macos-arm64.txt

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/electron-builder/ABCarus-macos-arm64.dmg
            dist/electron-builder/SHA256SUMS-macos-arm64.txt

  macos-x64:
    name: macOS (x64)
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Install bundled Python (PBS)
        run: bash devtools/pbs/pbs-install-unix.sh darwin-x64

      - name: Build macOS artifact
        run: npx electron-builder --mac --x64 --publish never

      - name: Capture stable-name dmg
        run: |
          dmg="$(ls -1 dist/electron-builder/*.dmg 2>/dev/null | head -n 1 || true)"
          if [[ -z "${dmg}" ]]; then
            echo "No .dmg found under dist/electron-builder"
            ls -la dist/electron-builder || true
            exit 1
          fi
          cp -f "${dmg}" dist/electron-builder/ABCarus-macos-x64.dmg

      - name: Compute SHA256
        run: |
          cd dist/electron-builder
          shasum -a 256 ABCarus-macos-x64.dmg > SHA256SUMS-macos-x64.txt

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/electron-builder/ABCarus-macos-x64.dmg
            dist/electron-builder/SHA256SUMS-macos-x64.txt

  windows-x64:
    name: Windows (x64)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Install bundled Python (PBS)
        run: pwsh -ExecutionPolicy Bypass -File devtools/pbs/pbs-install-windows.ps1 -Platform win-x64

      - name: Build Windows artifact
        run: npx electron-builder --win --x64 --publish never

      - name: Capture single-file portable exe
        run: |
          $portable = Get-ChildItem -Path "dist/electron-builder" -Filter "*.exe" | Where-Object {
            $_.Name -notmatch "Setup" -and $_.Name -notmatch "win-unpacked"
          } | Sort-Object Length -Descending | Select-Object -First 1
          if (-not $portable) {
            Write-Host "Top-level in dist/electron-builder:"
            Get-ChildItem -Force -Path "dist/electron-builder" | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "Portable exe not found under dist/electron-builder"
          }
          Copy-Item -Force $portable.FullName "dist/electron-builder/ABCarus-portable-x64.exe"

      - name: Create win-unpacked zip
        run: |
          $src = "dist/electron-builder/win-unpacked"
          $zip = "dist/electron-builder/ABCarus-win-unpacked-x64.zip"
          if (!(Test-Path $src)) { throw "Missing win-unpacked: $src" }
          if (!(Test-Path (Join-Path $src "ffmpeg.dll"))) {
            Write-Host "Top-level in win-unpacked:"
            Get-ChildItem -Force -Path $src | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "ffmpeg.dll is missing in win-unpacked"
          }
          $readme = @(
            "ABCarus portable build (Windows)",
            "",
            "IMPORTANT:",
            "  - This zip is a full folder-based build (win-unpacked).",
            "  - For a single-file portable build, use: ABCarus-portable-x64.exe",
            "",
            "  - Extract the entire zip to a folder before running.",
            "  - Do NOT run ABCarus.exe directly from inside the zip viewer,",
            "    otherwise required DLLs (e.g. ffmpeg.dll) may not be found."
          ) -join "`r`n"
          $readme | Out-File -Encoding ascii (Join-Path $src "README-PORTABLE.txt")
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path "$src/*" -DestinationPath $zip

      - name: Capture stable-name setup exe
        run: |
          $setup = Get-ChildItem -Path "dist/electron-builder" -Filter "*Setup*.exe" | Select-Object -First 1
          if (-not $setup) {
            Write-Host "Top-level in dist/electron-builder:"
            Get-ChildItem -Force -Path "dist/electron-builder" | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "Setup exe not found under dist/electron-builder"
          }
          Copy-Item -Force $setup.FullName "dist/electron-builder/ABCarus-setup-x64.exe"

      - name: Compute SHA256
        run: |
          $setup = Get-ChildItem -Path "dist/electron-builder" -Filter "ABCarus-setup-x64.exe" | Select-Object -First 1
          if (-not $setup) { throw "Stable setup exe not found under dist/electron-builder" }
          $zip = "dist/electron-builder/ABCarus-win-unpacked-x64.zip"
          $portable = Get-ChildItem -Path "dist/electron-builder" -Filter "ABCarus-portable-x64.exe" | Select-Object -First 1
          if (-not $portable) { throw "Portable exe not found under dist/electron-builder" }
          $lines = @()
          $lines += "$( (Get-FileHash -Algorithm SHA256 $setup.FullName).Hash.ToLower() )  $($setup.Name)"
          $lines += "$( (Get-FileHash -Algorithm SHA256 $zip).Hash.ToLower() )  $(Split-Path -Leaf $zip)"
          $lines += "$( (Get-FileHash -Algorithm SHA256 $portable.FullName).Hash.ToLower() )  $($portable.Name)"
          $lines | Out-File -Encoding ascii "dist/electron-builder/SHA256SUMS-windows.txt"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/electron-builder/ABCarus-setup-x64.exe
            dist/electron-builder/ABCarus-win-unpacked-x64.zip
            dist/electron-builder/ABCarus-portable-x64.exe
            dist/electron-builder/SHA256SUMS-windows.txt
