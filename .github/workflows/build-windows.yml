name: Build Windows

on:
  workflow_dispatch:

jobs:
  build-win:
    name: Windows x64
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Install bundled Python (PBS)
        run: pwsh -ExecutionPolicy Bypass -File devtools/pbs/pbs-install-windows.ps1 -Platform win-x64

      - name: Build Windows artifact
        run: npx electron-builder --win --x64 --publish never

      - name: Sanity check win-unpacked
        run: |
          $root = "dist/electron-builder/win-unpacked"
          if (!(Test-Path $root)) { throw "Missing win-unpacked: $root" }
          $required = @(
            "ABCarus.exe",
            "ffmpeg.dll",
            "resources/app.asar"
          )
          foreach ($r in $required) {
            $p = Join-Path $root $r
            if (!(Test-Path $p)) {
              Write-Host "Top-level in win-unpacked:"
              Get-ChildItem -Force -Path $root | ForEach-Object { Write-Host ("  - " + $_.Name) }
              throw "Missing required file: $p"
            }
          }

      - name: Sanity check portable exe
        run: |
          $portable = Get-ChildItem -Path "dist/electron-builder" -Filter "*.exe" | Where-Object {
            $_.Name -notmatch "Setup" -and $_.Name -notmatch "win-unpacked"
          } | Sort-Object Length -Descending | Select-Object -First 1
          if (-not $portable) {
            Write-Host "Top-level in dist/electron-builder:"
            Get-ChildItem -Force -Path "dist/electron-builder" | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "Portable exe not found under dist/electron-builder"
          }
          Write-Host "Found portable exe: $($portable.Name)"

      - name: Capture single-file portable exe
        run: |
          $portable = Get-ChildItem -Path "dist/electron-builder" -Filter "*.exe" | Where-Object {
            $_.Name -notmatch "Setup" -and $_.Name -notmatch "win-unpacked"
          } | Sort-Object Length -Descending | Select-Object -First 1
          if (-not $portable) {
            Write-Host "Top-level in dist/electron-builder:"
            Get-ChildItem -Force -Path "dist/electron-builder" | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "Portable exe not found under dist/electron-builder"
          }
          Copy-Item -Force $portable.FullName "dist/electron-builder/ABCarus-portable-x64.exe"

      - name: Create win-unpacked zip
        run: |
          $src = "dist/electron-builder/win-unpacked"
          $zip = "dist/electron-builder/ABCarus-win-unpacked-x64.zip"
          if (!(Test-Path $src)) { throw "Missing win-unpacked: $src" }
          if (!(Test-Path (Join-Path $src "ffmpeg.dll"))) {
            Write-Host "Top-level in win-unpacked:"
            Get-ChildItem -Force -Path $src | ForEach-Object { Write-Host ("  - " + $_.Name) }
            throw "ffmpeg.dll is missing in win-unpacked"
          }
          $readme = @(
            "ABCarus portable build (Windows)",
            "",
            "IMPORTANT:",
            "  - This zip is a full folder-based build (win-unpacked).",
            "  - For a single-file portable build, use: ABCarus-portable-x64.exe",
            "",
            "  - Extract the entire zip to a folder before running.",
            "  - Do NOT run ABCarus.exe directly from inside the zip viewer,",
            "    otherwise required DLLs (e.g. ffmpeg.dll) may not be found."
          ) -join "`r`n"
          $readme | Out-File -Encoding ascii (Join-Path $src "README-PORTABLE.txt")
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Path "$src/*" -DestinationPath $zip

      - name: Compute SHA256
        run: |
          $setup = Get-ChildItem -Path "dist/electron-builder" -Filter "*Setup*.exe" | Select-Object -First 1
          if (-not $setup) { throw "Setup exe not found under dist/electron-builder" }
          $zip = "dist/electron-builder/ABCarus-win-unpacked-x64.zip"
          $portable = Get-ChildItem -Path "dist/electron-builder" -Filter "ABCarus-portable-x64.exe" | Select-Object -First 1
          if (-not $portable) { throw "Portable exe not found under dist/electron-builder" }
          $lines = @()
          $lines += "$( (Get-FileHash -Algorithm SHA256 $setup.FullName).Hash.ToLower() )  $($setup.Name)"
          $lines += "$( (Get-FileHash -Algorithm SHA256 $zip).Hash.ToLower() )  $(Split-Path -Leaf $zip)"
          $lines += "$( (Get-FileHash -Algorithm SHA256 $portable.FullName).Hash.ToLower() )  $($portable.Name)"
          $lines | Out-File -Encoding ascii "dist/electron-builder/SHA256SUMS-windows.txt"
