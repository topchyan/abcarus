name: Build Windows

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-win:
    name: Windows x64
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify PBS locks
        run: npm run -s pbs:check

      - name: Install bundled Python (PBS)
        run: pwsh -ExecutionPolicy Bypass -File devtools/pbs/pbs-install-windows.ps1 -Platform win-x64

      - name: Build Windows artifact
        run: npx electron-builder --win --x64 --publish never

      - name: Sanity check win-unpacked
        run: |
          $root = "dist/electron-builder/win-unpacked"
          if (!(Test-Path $root)) { throw "Missing win-unpacked: $root" }
          $required = @(
            "ABCarus.exe",
            "ffmpeg.dll",
            "resources/app.asar"
          )
          foreach ($r in $required) {
            $p = Join-Path $root $r
            if (!(Test-Path $p)) {
              Write-Host "Top-level in win-unpacked:"
              Get-ChildItem -Force -Path $root | ForEach-Object { Write-Host ("  - " + $_.Name) }
              throw "Missing required file: $p"
            }
          }

      - name: Create portable SFX (optional)
        run: |
          $repo = $env:GITHUB_WORKSPACE
          if (!$repo) { $repo = (Get-Location).Path }
          $src = Join-Path $repo "dist/electron-builder/win-unpacked"
          $out = Join-Path $repo "dist/electron-builder/ABCarus-win-unpacked-x64.exe"
          if (!(Test-Path $src)) { throw "Missing win-unpacked: $src" }

          $sevenZip = @(
            "C:\\Program Files\\7-Zip\\7z.exe",
            "C:\\Program Files (x86)\\7-Zip\\7z.exe"
            "C:\\ProgramData\\chocolatey\\bin\\7z.exe"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          $sevenZipSfx = @(
            "C:\\Program Files\\7-Zip\\7z.sfx",
            "C:\\Program Files (x86)\\7-Zip\\7z.sfx"
            "C:\\ProgramData\\chocolatey\\lib\\7zip\\tools\\7z.sfx"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (!$sevenZip -or !$sevenZipSfx) {
            Write-Host "Skipping SFX build (7-Zip SFX not found on runner)."
            exit 0
          }

          $tmp = Join-Path $env:TEMP ("abcarus-sfx-" + [System.Guid]::NewGuid().ToString("N"))
          New-Item -ItemType Directory -Force -Path $tmp | Out-Null

          $payload = Join-Path $tmp "payload.7z"
          $srcAbs = (Resolve-Path $src).Path
          & $sevenZip a -t7z -mx=9 $payload (Join-Path $srcAbs "*") | Out-Host
          if ($LASTEXITCODE -ne 0) { throw "7z failed building payload (exit $LASTEXITCODE)" }

          $config = Join-Path $tmp "config.txt"
          $configText = @(
            ';!@Install@!UTF-8!',
            'Title="ABCarus (portable)"',
            'BeginPrompt="Extract ABCarus portable build to a folder. Do NOT run from inside a zip viewer."',
            'RunProgram="ABCarus.exe"',
            ';!@InstallEnd@!'
          ) -join "`r`n"
          $configText | Out-File -Encoding utf8 $config

          $bytes = New-Object System.Collections.Generic.List[byte]
          $bytes.AddRange([System.IO.File]::ReadAllBytes($sevenZipSfx))
          $bytes.AddRange([System.Text.Encoding]::UTF8.GetBytes((Get-Content -Raw $config)))
          $bytes.AddRange([System.IO.File]::ReadAllBytes($payload))
          New-Item -ItemType Directory -Force -Path (Split-Path -Parent $out) | Out-Null
          [System.IO.File]::WriteAllBytes($out, $bytes.ToArray())

          Write-Host "Created SFX: $out"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ABCarus-windows-x64
          path: dist/electron-builder/**
          if-no-files-found: error
