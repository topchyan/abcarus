---
title: "ADR-0002: Incremental Full Scan (Gated)"
date: 2026-01-02
status: "Accepted with constraints"
---

# ADR-0002: Incremental Full Scan библиотеки (gated)

## Контекст

Full scan библиотеки (`scanLibrary`) даёт пользователю привычный UX: дерево быстро и предсказуемо заполняется тюнами под файлами. При больших коллекциях и при повторных открытиях/refresh появляется O(N)-штраф: чтение и парс всех файлов заново.

В проекте уже существует best-effort persisted index в `userData`. Он может выступать ускорителем для повторных запусков при корректной валидации по `mtimeMs/size`, но не должен становиться новым источником истины.

## Решение

Делаем `scanLibrary()` инкрементальным без изменения UX:
- Для неизменённых файлов (совпадают `mtimeMs` и `size`) берём `tunes/xIssues/header` из persisted index/кеша, не читаем файл.
- Для новых/изменённых файлов выполняем чтение и парс, обновляем persisted index.
- Best-effort чистка удалённых записей — только в пределах текущего `libraryRoot`.
- Прогресс остаётся throttled, финальный `done` обязателен. Допускается добавлять счётчики `cachedCount/parsedCount` в payload, без роста частоты событий.

## Ограничения (gates)

1. Persisted index — только accelerator, не source of truth. Окончательная валидация — при `openTune`: если `X/offset/структура` не сходятся, выполняем forced reparse файла и самокоррекцию записи индекса.
2. Никаких UX-изменений: не вводим “Loading…” и промежуточные состояния в Tree/Modal.
3. Индекс scoped по `libraryRoot/roots`: чистка удалённых — только в пределах текущих roots.
4. Версионирование формата + атомарная запись (temp + rename/replace) + безопасный fallback: при ошибке/несовместимости индекс игнорируется, выполняется rebuild.
5. Обязателен kill-switch (без UI): переключатель env/config, чтобы вернуть режим “parse всё” без отката коммитов.

## Реализация (вертикальный срез)

Только узкий срез в `scanLibrary/refresh`:
- `scanLibrary()` использует persisted index для неизменённых, парсит только изменённые, делает cleanup под root.
- `openTune/selectTune` валидирует соответствие `X/offset` и при несовпадении принудительно перепарсивает файл и переоткрывает тюн.
- Kill-switch: `ABCARUS_DISABLE_LIBRARY_INDEX=1` выключает использование persisted index (ускоритель).

## Метрики/ожидаемый эффект

- Улучшение: повторные `scanLibrary()` (open folder / refresh) должны становиться быстрее при больших библиотеках за счёт reuse неизменённых файлов.
- Guardrail: UX и поведение Tree/Modal остаются как раньше (без новых промежуточных состояний).

