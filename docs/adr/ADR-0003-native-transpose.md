# ADR-0003: Нативная транспозиция (замена abc2abc) + микротональная 53-EDO поддержка

Дата: 4 января 2026  
Статус: Accepted

## Контекст

ABCarus исторически использовал внешний инструмент `abc2abc` (abcMIDI) для транспозиции. Это добавляет зависимость от бинарника в PATH, различия поведения между платформами и ограничивает развитие (в частности, микротональная логика и работа с gchords в кавычках).

Нужно:
- транспонировать “внутри приложения” (drop-in replacement для semitone transpose), сохраняя `abc2abc` как fallback;
- корректно обрабатывать микротональные случай `%%MIDI temperamentequal 53` (53-EDO) и не ломать текст/аннотации;
- транспонировать аккорды (gchords) строго в 12-TET.

## Решение

Вводится “native transpose” как основной путь транспозиции в UI:
- По умолчанию включён (`useNativeTranspose: true`), может быть выключен в Settings.
- В случае ошибки/несовместимости нативного пути выполняется fallback на `abc2abc` (если доступен).

Нативная транспозиция реализована в `src/renderer/transpose.mjs` и используется из renderer (через существующие UI/IPC пути), без изменения имен IPC и menu action строк.

### 53-EDO (temperamentequal 53)

При наличии `%%MIDI temperamentequal 53` транспозиция работает в “53-режиме”:
- применяется детерминированный “western semitone” сдвиг (±1) в 53-EDO;
- транспонируются микротональные акциденталы в `K:` и inline `[K:...]`;
- обработка *не трогает* содержимое `!decorations!` и любых bracketed полей `[X:...]` кроме `[K:...]`, чтобы избежать порчи текста и каскадных ошибок при повторных транспозициях.

### gchords (аккорды в кавычках)

Строки вида `"Em7"`, `"A7/E"`, `"C#m7/G#"` транспонируются как 12-TET:
- транспонируется root и (если есть) slash-bass;
- текстовые аннотации в кавычках, которые не выглядят как аккорды, сохраняются как есть.

## Область (где искать код)

- Алгоритм: `src/renderer/transpose.mjs`
- Включение/фоллбэк: `src/renderer/renderer.js` (useNativeTranspose)
- Настройка: `src/renderer/index.html`, `src/renderer/settings.js`
- Интеграция header (temperamentequal из header): `src/renderer/renderer.js` (передача effective header в transpose)

## Последствия

Положительные:
- меньше внешних зависимостей (для транспозиции по умолчанию `abc2abc` не обязателен);
- контролируемое поведение и возможность точечных исправлений (включая микротональные кейсы);
- переносимость на Windows/macOS упрощается (падает число “обязательных бинарников”).

Негативные:
- ответственность за корректность транспозиции теперь в кодовой базе ABCarus;
- часть сложных/редких кейсов может требовать строгого отказа или fallback, чтобы не рисковать порчей данных.

## Инварианты

- Tolerant-read / strict-write: нативный путь должен быть консервативен и предпочитать отказ/фоллбэк вместо “тихой порчи”.
- Не спамить renderer прогрессом/статусами.
- Стабильность при повторных транспозициях: отсутствие “дрейфа” регистра/текста из-за обработки не-нотных конструкций.

## Авторство идеи (не юридическое заключение)

Идея “native transpose” как замены `abc2abc` и требования к музыкальному поведению/качеству были сформулированы владельцем проекта (Avetik) и воплощены в коде ABCarus. Юридический статус и права определяются лицензией репозитория и договорённостями участников проекта.

